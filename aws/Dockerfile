FROM strapi/base:12-alpine

RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

COPY ./app /usr/src/app

EXPOSE 1337

ARG ADMIN_JWT_SECRET
ARG JWT_SECRET
ARG DB_HOST
ARG DB_PORT
ARG DB_NAME
ARG DB_USER
ARG DB_PASS
ARG DB_SSL
ARG MAIL_PROVIDER
ARG MAIL_USERNAME
ARG MAIL_PASSWORD
ARG MAIL_REGION
ARG MAIL_DEFAULT_FROM
ARG STORAGE_PROVIDER
ARG STORAGE_ACCESS_KEY
ARG STORAGE_SECRET_KEY
ARG STORAGE_BUCKET
ARG STORAGE_REGION

ENV NODE_ENV=production
ENV ADMIN_JWT_SECRET=$ADMIN_JWT_SECRET
ENV JWT_SECRET=$JWT_SECRET
ENV DB_HOST=$DB_HOST
ENV DB_PORT=$DB_PORT
ENV DB_NAME=$DB_NAME
ENV DB_USER=$DB_USER
ENV DB_PASS=$DB_PASS
ENV DB_SSL=$DB_SSL
ENV MAIL_PROVIDER=$MAIL_PROVIDER
ENV MAIL_USERNAME=$MAIL_USERNAME
ENV MAIL_PASSWORD=$MAIL_PASSWORD
ENV MAIL_REGION=$MAIL_REGION
ENV MAIL_DEFAULT_FROM=$MAIL_DEFAULT_FROM
ENV STORAGE_PROVIDER=$STORAGE_PROVIDER
ENV STORAGE_ACCESS_KEY=$STORAGE_ACCESS_KEY
ENV STORAGE_SECRET_KEY=$STORAGE_SECRET_KEY
ENV STORAGE_BUCKET=$STORAGE_BUCKET
ENV STORAGE_REGION=$STORAGE_REGION

RUN rm -rf node_modules 
RUN npm install --no-audit
RUN npm run build
