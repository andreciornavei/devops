########################################
## BASE-IMAGE                         ##
########################################
## Define the base image to be shared ##
## through every build scenarios      ##
########################################
FROM strapi/base:14-alpine

# 1) define a pretty workdir to run application
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

# 2) copy only the package json to
# install dependencies
COPY ./app /usr/src/app

# 3) install dependencies
RUN rm -rf node_modules
RUN npm install --no-audit

# 4) expose application port
EXPOSE 80

# 5) ARGUMENTS
ARG NODE_ENV
ARG ADMIN_JWT_SECRET
ARG GCS_SERVICE_ACCOUNT
ARG GCS_BUCKET_NAME
ARG DB_HOST
ARG DB_PORT
ARG DB_NAME
ARG DB_USER
ARG DB_PASS
ARG DB_SSL
ARG MAUTIC_CONTACT_FORM_ID
ARG MAUTIC_ESTIMATION_FORM_ID
ARG MAUTIC_INTERESTED_PARTNER_FORM_ID
ARG SENTRY_DSN
ARG PORTAL_URL
ARG GOOGLE_ADS_CLI_ID
ARG GOOGLE_ADS_CLI_SECRET
ARG GOOGLE_ADS_DEV_TOKEN
ARG GOOGLE_ADS_CALLBACK_URL
ARG GOOGLE_ADS_CUSTOMER_ID
ARG GOOGLE_ADS_CAMPAIGN_ID

# 6) ENV. VARIABLES
ENV PORT=80
ENV NODE_ENV=$NODE_ENV
ENV ADMIN_JWT_SECRET=$ADMIN_JWT_SECRET
ENV GCS_SERVICE_ACCOUNT=$GCS_SERVICE_ACCOUNT
ENV GCS_BUCKET_NAME=$GCS_BUCKET_NAME
ENV DB_HOST=$DB_HOST
ENV DB_PORT=$DB_PORT
ENV DB_NAME=$DB_NAME
ENV DB_USER=$DB_USER
ENV DB_PASS=$DB_PASS
ENV DB_SSL=$DB_SSL
ENV MAUTIC_CONTACT_FORM_ID=$MAUTIC_CONTACT_FORM_ID
ENV MAUTIC_ESTIMATION_FORM_ID=$MAUTIC_ESTIMATION_FORM_ID
ENV MAUTIC_INTERESTED_PARTNER_FORM_ID=$MAUTIC_INTERESTED_PARTNER_FORM_ID
ENV SENTRY_DSN=$SENTRY_DSN
ENV PORTAL_URL=$PORTAL_URL
ENV GOOGLE_ADS_CLI_ID=$GOOGLE_ADS_CLI_ID
ENV GOOGLE_ADS_CLI_SECRET=$GOOGLE_ADS_CLI_SECRET
ENV GOOGLE_ADS_DEV_TOKEN=$GOOGLE_ADS_DEV_TOKEN
ENV GOOGLE_ADS_CALLBACK_URL=$GOOGLE_ADS_CALLBACK_URL
ENV GOOGLE_ADS_CUSTOMER_ID=$GOOGLE_ADS_CUSTOMER_ID
ENV GOOGLE_ADS_CAMPAIGN_ID=$GOOGLE_ADS_CAMPAIGN_ID

# 7) BUILD APP
RUN npm run build

# 8) MIGRATE DATABASE UPDATES
# RUN npm run prisma:deploy

# 9) EXECUTE COMMAND
# WHEN CONTAINER IS READY
CMD [ "npm", "run", "start" ]